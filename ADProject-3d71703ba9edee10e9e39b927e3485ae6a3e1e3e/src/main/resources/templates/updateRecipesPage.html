<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update Recipe</title>
    <style>
        /* 样式部分保持不变 */
    </style>
</head>
<body>
    <h2>Update Recipe</h2>
    <form id="recipeForm" action="/recipe/edit" method="post">
		<input type="hidden" id="idInput" name="id" th:value="${recipe.id}">
		<input type="hidden" id="numberOfSavedInput" name="numberOfSaved" th:value="${recipe.numberOfSaved}">
		<input type="hidden" id="numberOfStepsInput" name="numberOfSteps" th:value="${recipe.numberOfSteps}">
		<input type="hidden" id="healthScoreInput" name="healthScore" th:value="${recipe.healthScore}">
		<input type="hidden" id="notesInput" name="notes" th:value="${recipe.notes}">
		<input type="hidden" id="caloriesInput" name="calories" th:value="${recipe.calories}">
		<input type="hidden" id="proteinInput" name="protein" th:value="${recipe.protein}">
		<input type="hidden" id="carbohydrateInput" name="carbohydrate" th:value="${recipe.carbohydrate}">
		<input type="hidden" id="sugarInput" name="sugar" th:value="${recipe.sugar}">
		<input type="hidden" id="sodiumInput" name="sodium" th:value="${recipe.sodium}">
		<input type="hidden" id="fatInput" name="fat" th:value="${recipe.fat}">
		<input type="hidden" id="saturatedFatInput" name="saturatedFat" th:value="${recipe.saturatedFat}">
		
		
		<input type="hidden" id="ratingInput" name="rating" th:value="${recipe.rating}">
		
		
		
        <label for="nameInput">Recipe Name:</label>
        <input type="text" id="nameInput" name="name" required th:value="${recipe.name}"> 
        <br>
      
        <label for="descriptionInput">Description:</label>
        <input type="text" id="descriptionInput" name="description" required th:value="${recipe.description}">      
        <br>
        
        <label for="servingsInput">Servings:</label>
        <input type="number" id="servingsInput" name="servings" required min="1" step="1" th:value="${recipe.servings}">
        <!-- min="1" 表示最小值为1，step="1" 表示步长为1，即只能输入整数 -->
        <br>
        
        <label for="preparationTimeInput">Preparation Time:</label>
        <input type="number" id="preparationTimeInput" name="preparationTime" required min="1" step="1" th:value="${recipe.preparationTime}">
        
        <!-- 添加按钮或下拉列表来选择时间单位 -->
        <label for="timeUnit">Time Unit:</label>
        <select id="timeUnit" name="timeUnit">
            <option value="minutes">Minutes</option>
            <option value="hours">Hours</option>
        </select>
        <br>
        
        <label for="ingredientsInput">Ingredients:</label>
        <div id="ingredientsContainer">
            <div th:each="ingredient, status : ${recipe.ingredients}">
        	<input type="text" name="ingredients" th:value="${ingredient}"> 	
        	<button type="button" onclick="removeRows(event)">Delete</button>


        	<br>
    		</div>
		    
        </div>

        <!-- 按钮触发添加新原料框 -->
        <button type="button" onclick="addIngredient()">Add Ingredient</button>
        <br>
        
        <label for="stepsInput">steps:</label>
        <div id="stepsContainer">
            <div th:each="step, status : ${recipe.steps}">
        	<input type="text" name="steps" th:value="${step}">
        	<button type="button" onclick="removeRows(event)">Delete</button>
        	<br>
    		</div>

    		
        </div>

        <!-- 按钮触发添加新指引框 -->
        <button type="button" onclick="addstep()">Add step</button>
        <br>
        
        
        <!-- Upload Picture 输入框 -->
        <label for="pictureInput">Upload Picture:</label>
        <input type="file" id="pictureInput" name="image" accept="image/*" style="display: none;" class="fileBtn" onchange="selectFromFile()">
        

        <!-- 图片预览框 -->
        <div id="picturePreview"></div>
        
        <button type="button" onclick="selectFromFile()">Select Picture</button>
		<br>
        
        
       
        
        <!-- Tags 输入框 --> 
        <label for="tagsInput">Tags:</label>
        <div id="tagsContainer">
            <div th:each="tag, status : ${recipe.tags}">
        	<input type="text" name="tags" th:value="${tag}" readonly>
        	<button type="button" onclick="removeRows(event)">Delete</button>
        	<br>
    		</div>
    		
    		<input type="text" id="newTagInput" oninput="getMatchingTags(this.value)">
    		<div id="tagDropdown"></div>
		   
        </div>
        
        
        
        <p th:text="${recipe.status}"></p>
        <label for="public">Public</label>
    	<input type="radio" id="public" name="status" value="Public" th:checked="${recipe.status == 'Public'}">

    	<label for="private">Private</label>
    	<input type="radio" id="private" name="status" value="Private" th:checked="${recipe.status == 'Private'}">

    	
		<br>
    
        <button type="submit">Update Recipe</button>
        
    </form>
    
    <script>
        function addIngredient() {
        var container = document.getElementById("ingredientsContainer");
        var ingredientRow = document.createElement("div");
        
        var input = document.createElement("input");
        input.type = "text";
        input.name = "ingredients";
        input.required = true;
        
        // 创建删除按钮
        var deleteButton = document.createElement("button");
        deleteButton.type = "button";
        deleteButton.textContent = "Delete";
        
        // 删除
        deleteButton.onclick = function() {
			removeRow(ingredientRow,container);
		};

        ingredientRow.appendChild(input);
        ingredientRow.appendChild(deleteButton);
        container.appendChild(ingredientRow);
       
        
        
    }
    


        function removeRows(event) {
		    // 获取点击的按钮所在的父级div
		    var ingredientDiv = event.target.parentNode;
		
		    // 从父级div的父级div（即ingredientsContainer）中移除当前行
		    ingredientDiv.parentNode.removeChild(ingredientDiv);
		    
		    updateNumberOfIngredients();
		    updateNumberOfSteps();
		}

		function removeRow(row,container) {
		    
		    container.removeChild(row);
		    updateNumberOfIngredients();
		    updateNumberOfSteps();
		}


    
	    function updateNumberOfIngredients() {
		    var container = document.getElementById("ingredientsContainer");
		    var numberOfIngredientsInput = document.getElementById("numberOfIngredientsInput");
		
		    // 设置 numberOfSteps 的值为当前行数
		    numberOfIngredientsInput.value = (container.getElementsByTagName("div").length);
		}
    
    
    
        
        
        function addstep() {
            var container = document.getElementById("stepsContainer");
            var stepRow = document.createElement("div");
            
            var input = document.createElement("input");
            input.type = "text";
            input.name = "steps";
            input.required = true;
            
            // 创建删除按钮
	        var deleteButton = document.createElement("button");
	        deleteButton.type = "button";
	        deleteButton.textContent = "Delete";
	        
	        // 删除
        	deleteButton.onclick = function() {
				removeRow(stepRow,container);
			};
        
            stepRow.appendChild(input);
            stepRow.appendChild(deleteButton);
            container.appendChild(stepRow);
            
            updateNumberOfSteps();
        }
        
    
	    function updateNumberOfSteps() {
	    var container = document.getElementById("stepsContainer");
	    var numberOfStepsInput = document.getElementById("numberOfStepsInput");
	
	    // 设置 numberOfSteps 的值为当前行数
	    numberOfStepsInput.value = (container.getElementsByTagName("div").length);
	}
    
    

        
        function getMatchingTags(keyword) {
		    var dropdown = document.getElementById("tagDropdown");
		
		    // 使用Ajax向服务器请求匹配的Tag选项
		    // 请确保你的服务器地址和端口正确
		    fetch("/getTags?keyword=" + keyword)
		        .then(response => response.json())
		        .then(tags => {
		            // 清空下拉菜单
		            dropdown.innerHTML = "";
		
		            // 将匹配的Tag选项添加到下拉菜单中
		            tags.forEach(tag => {
		                var option = document.createElement("div");
		                option.textContent = tag;
		                option.onclick = function () {
		                    selectTag(tag);
		                };
		                dropdown.appendChild(option);
		            });
		
		            // 在下拉菜单添加完毕后，将其移动到tagsContainer的最下方
		            moveDropdownToBottom();
		        });
		}
		
		function selectTag(tag) {
		    var tagsContainer = document.getElementById("tagsContainer");
		    var newTagInput = document.getElementById("newTagInput");
		    var tagDropdown = document.getElementById("tagDropdown");
		
		    // 在选择标签时，将新标签添加到tagsContainer的下方
		    var newTagDiv = document.createElement("div");
		    newTagDiv.textContent = tag;
		
		    // 创建删除按钮
		    var deleteButton = document.createElement("button");
		    deleteButton.type = "button";
		    deleteButton.textContent = "Delete";
		    deleteButton.onclick = function () {
		        removeRow(newTagDiv, tagsContainer);
		    };
		
		    // 添加新标签和删除按钮
		    newTagDiv.appendChild(deleteButton);
		    tagsContainer.appendChild(newTagDiv);
		
		    // 创建隐藏的input元素
		    var input = document.createElement("input");
		    input.type = "text";
		    input.name = "tags"; // 设置name属性
		    input.value = tag;
		    input.required = true;
		    input.style.display = "none"; // 隐藏input元素
		
		    // 将隐藏的input元素添加到tagsContainer
		    tagsContainer.appendChild(input);
		
		    // 将新标签输入框移动到tagsContainer的下方
		    tagsContainer.appendChild(newTagInput);
		
		    // 将下拉菜单(tagDropdown)移动到tagsContainer的最下方
		    moveDropdownToBottom();
		
		    // 清空下拉菜单
		    document.getElementById("tagDropdown").innerHTML = "";
		    // 清空输入框
		    document.getElementById("newTagInput").value = "";
		}

		
		function moveDropdownToBottom() {
		    var tagsContainer = document.getElementById("tagsContainer");
		    var tagDropdown = document.getElementById("tagDropdown");
		
		    // 将下拉菜单(tagDropdown)移动到tagsContainer的最下方
		    tagsContainer.appendChild(tagDropdown);
		    
		    
		}
	

    
        function selectFromFile() {
            document.getElementById("pictureInput").click();
		}

		// 当文件选择框内容改变时触发
		document.getElementById("pictureInput").addEventListener("change", function() {
    		uploadAndPreview();
		});

		function uploadAndPreview() {
		    var pictureInput = document.getElementById("pictureInput");
		    var picturePreview = document.getElementById("picturePreview");
		
		    // 清空图片预览框
		    picturePreview.innerHTML = "";
		
		    // 获取用户选择的文件
		    var file = pictureInput.files[0];
		
		    // 创建一个 FileReader 对象
		    var reader = new FileReader();
		
		    // 设置文件加载完成后的回调函数
		    reader.onload = function (e) {
		        // 创建一个 <img> 元素用于显示预览图片
		        var img = document.createElement("img");
		        img.src = e.target.result;
		        img.style.maxWidth = "300px";  // 设置图片最大宽度
		        img.style.maxHeight = "300px"; // 设置图片最大高度
		        picturePreview.appendChild(img);  // 将图片添加到预览框
		    };
		
		    // 读取文件内容
		    reader.readAsDataURL(file);
		        }
		        
	    var recipeStatus = /*[[${recipe.status}]]*/ 'unknown';
	    console.log("Recipe Status:", recipeStatus);
	    
	    
		document.getElementById("recipeForm").addEventListener("submit", function (event) {
	        // 阻止默认的表单提交
	        event.preventDefault();
	
	        // 获取输入框中的时间值和时间单位
	        var preparationTimeInput = document.getElementById("preparationTimeInput");
	        var selectedUnit = document.getElementById("timeUnit").value;
	
	        // 将时间值根据时间单位进行转换
	        if (selectedUnit === "hours") {
	            preparationTimeInput.value = parseInt(preparationTimeInput.value) * 60;
	        }
	
	        // 提交表单
	        this.submit();
	    });
	
    </script>
</body>
</html>
