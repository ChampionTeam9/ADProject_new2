<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Recipe</title>
</head>
<body>
    <h2>Add Recipe</h2>
    <form th:action="@{/recipe/create}" th:object="${recipe}" method="post" enctype="multipart/form-data" id="recipeForm">
		<input type="hidden" id="ingredientIds" name="ingredientIds" value=""/>
		
        <label for="nameInput">Recipe Name:</label>
        <input type="text" id="nameInput" name="name" th:field="*{name}" required> 
        <br />
      
        <label for="descriptionInput">Description:</label>
        <input type="text" id="descriptionInput" name="description" th:field="*{description}" required>      
        <br />
        
        <label for="servingsInput">Servings:</label>
        <input type="number" id="servingsInput" name="servings" required min="1" step="1" th:field="*{servings}">
        <!-- min="1" 表示最小值为1，step="1" 表示步长为1，即只能输入整数 -->
        <br />
        
        <label for="preparationTimeInput">Preparation Time:</label>
        <input type="number" id="preparationTimeInput" name="preparationTime" required min="1" step="1" th:field="*{preparationTime}">
        
        <!-- 添加按钮或下拉列表来选择时间单位 -->
        <label for="timeUnit"></label>
        <select id="timeUnit" name="timeUnit">
            <option value="minutes">Minutes</option>
            <option value="hours">Hours</option>
        </select>
        <br />
        
        <label for="ingredientsInput">Ingredients:</label>
        <div name="ingredientsInput">
            <input type="text" placeholder="Add an ingredient" id="addIngredientInput" />
			<button type="button" id="addIngredientBtn">Add</button>
        </div>
        <table id="itemTable">
		</table>
        <br />
        
        <label for="stepsInput">Steps:</label>
        <div name="stepsInput">
            <input type="text" placeholder="Add a step" id="addStepInput" />
			<button type="button" id="addStepBtn">Add</button>
        </div>
        <table id="stepsTable">
		</table>
        <br />
        
        <!-- Upload Picture 输入框 -->
        <label for="pictureInput">Upload Picture:</label>
        <input type="file" id="pictureInput" name="image" accept="image/*" style="display: none;" class="fileBtn" onchange="fileBtn(this)">

        <!-- 图片预览框 -->
        <div id="picturePreview"></div>
        
        <button type="button" onclick="selectFromFile()">Select Picture</button>
		<br />
        
		<!-- Tags 输入框 --> 
        <label for="tagsInput">Tags:</label>
        <div id="tagsContainer">
    		<input type="text" id="newTagInput" oninput="getMatchingTags(this.value)">
    		<div id="tagDropdown"></div>
        </div>
		
        <label for="public">Public</label>
    	<input type="radio" id="public" name="status" value="Public">

    	<label for="private">Private</label>
    	<input type="radio" id="private" name="status" value="Private">

    	<br />    
        <input type="submit" value="Save" />
    </form>
    
    <script>
		document.addEventListener("DOMContentLoaded", function(event) {
			const ingredientIdsEle = document.getElementById("ingredientIds");
			const addIngredientInput = document.getElementById("addIngredientInput");
			const addIngredientBtn = document.getElementById("addIngredientBtn");
			addIngredientBtn.addEventListener("click", (event) => {
				var newIngredient = addIngredientInput.value;
				addItem(newIngredient, function (error, newIngredientId) {
				    if (error) {
				        console.error(error);
				    } else {
				        console.log("New Ingredient ID:", newIngredientId);
				        var ingredientIdsStr = ingredientIdsEle.value;
				        if (ingredientIdsEle.value == ""){
							ingredientIdsEle.value = newIngredientId;
						} else {
							ingredientIdsEle.value = ingredientIdsStr + "," + newIngredientId;
						}
				        console.log("ingredientIdsEle.value: " + ingredientIdsEle.value);
				        addRow(newIngredient, newIngredientId);
				    }
				});
			})
			
			const addStepInput = document.getElementById("addStepInput");
			const addStepBtn = document.getElementById("addStepBtn");
			addStepBtn.addEventListener("click", (event) => {
				var newStep = addStepInput.value;
				addStep(newStep);
			})
		});
		
		function addItem(newIngredient, callback){
			console.log("add item function");
			let xhr = new XMLHttpRequest();
		    xhr.open("POST", "/recipe/addItem");
		    xhr.setRequestHeader("Content-Type", "application/json; charset=utf8");
		    xhr.onreadystatechange = function () {
		        if (xhr.readyState == 4) {
		            if (xhr.status == 200) {
		                console.log("response ok");
		                let data = JSON.parse(xhr.responseText);
		                let newIngredientId = data.id;
		                callback(null, newIngredientId);
		            } else {
		                callback("Error saving item", null);
		            }
		        }
		    }
		    let data = {
		        "ingredientName": newIngredient,
		    }
		    xhr.send(JSON.stringify(data));
		}
		
        function addRow(ingredientName, ingredientId) {
	        console.log("add row function");
			console.log("ingredientName: " + ingredientName);
			const itemTable = document.getElementById("itemTable");
			var newRow = itemTable.insertRow(-1);
			var cell1 = newRow.insertCell(0);
			cell1.className = "itemText";
			cell1.innerHTML = ingredientName;
	        
	        // 创建删除按钮
	        var cell2 = newRow.insertCell(1);
	        var deleteButton = document.createElement("button");
	        deleteButton.type = "button";
	        deleteButton.textContent = "Delete";
	        deleteButton.id = ingredientId;
	        
	        // 删除
	        deleteButton.onclick = function(e) {
				var deleteButton = e.target;
				console.log(deleteButton);
				var ingredientId = this.id;
				console.log("delete button ingredientID: " + ingredientId);
				removeItem(ingredientId);
				var row = deleteButton.closest("tr");
				row.remove();
			};
	        cell2.appendChild(deleteButton);
	    }
    
        function removeItem(id) {
		    const ingredientIdsEle = document.getElementById("ingredientIds");
		    var ingredientIdsStr = ingredientIdsEle.value;
	        if (ingredientIdsEle.value.length == 1){
				ingredientIdsEle.value = "";
			} else {
				ingredientIdsEle.value = ingredientIdsStr.replace(id, "");
			}
			console.log("ingredingredientIdsEle.value: " + ingredientIdsEle.value);
		}
    
        function addStep(newStep) {
            const stepsTable = document.getElementById("stepsTable");
            var count = stepsTable.getElementsByTagName("tr").length;
			var newRow = stepsTable.insertRow(-1);
			var cell1 = newRow.insertCell(0);
			cell1.className = "stepText";
			cell1.innerHTML = newStep;
			
			var input = document.createElement("input");
			input.type = "hidden";
			input.name = "steps[" + count + "]";
			input.value = newStep;
			cell1.appendChild(input);
	        
	        // 创建删除按钮
	        var cell2 = newRow.insertCell(1);
	        var deleteButton = document.createElement("button");
	        deleteButton.type = "button";
	        deleteButton.textContent = "Delete";
	        deleteButton.id = "stepsDelete" + count;
	        
	        // 删除
	        deleteButton.onclick = function(e) {
				var deleteButton = e.target;
				console.log(deleteButton);
				var stepId = this.id;
				console.log("delete button stepId: " + stepId);
				stepId = parseInt(stepId.substring(11));
				console.log("delete button stepId: " + stepId);
				var row = deleteButton.closest("tr");
				row.remove();
			};
	        cell2.appendChild(deleteButton);
        }

	    function getMatchingTags(keyword) {
		    var dropdown = document.getElementById("tagDropdown");
		
		    // 使用Ajax向服务器请求匹配的Tag选项
		    // 请确保你的服务器地址和端口正确
		    fetch("/getTags?keyword=" + keyword)
		        .then(response => response.json())
		        .then(tags => {
		            // 清空下拉菜单
		            dropdown.innerHTML = "";
		
		            // 将匹配的Tag选项添加到下拉菜单中
		            tags.forEach(tag => {
		                var option = document.createElement("div");
		                option.textContent = tag;
		                option.onclick = function () {
		                    selectTag(tag);
		                };
		                dropdown.appendChild(option);
		            });
		
		            // 在下拉菜单添加完毕后，将其移动到tagsContainer的最下方
		            moveDropdownToBottom();
		        });
			}
		
		function selectTag(tag) {
		    var tagsContainer = document.getElementById("tagsContainer");
		    var newTagInput = document.getElementById("newTagInput");
		    var tagDropdown = document.getElementById("tagDropdown");
		
		    // 在选择标签时，将新标签添加到tagsContainer的下方
		    var newTagDiv = document.createElement("div");
		    newTagDiv.textContent = tag;
		
		    // 创建删除按钮
		    var deleteButton = document.createElement("button");
		    deleteButton.type = "button";
		    deleteButton.textContent = "Delete";
		    deleteButton.onclick = function () {
		        removeRow(newTagDiv, tagsContainer);
		    };
		
		    // 添加新标签和删除按钮
		    newTagDiv.appendChild(deleteButton);
		    tagsContainer.appendChild(newTagDiv);
		
		    // 创建隐藏的input元素
		    var input = document.createElement("input");
		    input.type = "text";
		    input.name = "tags"; // 设置name属性
		    input.value = tag;
		    input.required = true;
		    input.style.display = "none"; // 隐藏input元素
		
		    // 将隐藏的input元素添加到tagsContainer
		    tagsContainer.appendChild(input);
		
		    // 将新标签输入框移动到tagsContainer的下方
		    tagsContainer.appendChild(newTagInput);
		
		    // 将下拉菜单(tagDropdown)移动到tagsContainer的最下方
		    moveDropdownToBottom();
		
		    // 清空下拉菜单
		    document.getElementById("tagDropdown").innerHTML = "";
		    // 清空输入框
		    document.getElementById("newTagInput").value = "";
		}

		
		function moveDropdownToBottom() {
		    var tagsContainer = document.getElementById("tagsContainer");
		    var tagDropdown = document.getElementById("tagDropdown");
		
		    // 将下拉菜单(tagDropdown)移动到tagsContainer的最下方
		    tagsContainer.appendChild(tagDropdown);
		}
    
        function selectFromFile() {
            document.getElementById("pictureInput").click();
		}

		// 当文件选择框内容改变时触发
		document.getElementById("pictureInput").addEventListener("change", function() {
    		uploadAndPreview();
		});

		function uploadAndPreview() {
		    var pictureInput = document.getElementById("pictureInput");
		    var picturePreview = document.getElementById("picturePreview");
		
		    // 清空图片预览框
		    picturePreview.innerHTML = "";
		
		    // 获取用户选择的文件
		    var file = pictureInput.files[0];
		
		    // 创建一个 FileReader 对象
		    var reader = new FileReader();
		
		    // 设置文件加载完成后的回调函数
		    reader.onload = function (e) {
		        // 创建一个 <img> 元素用于显示预览图片
		        var img = document.createElement("img");
		        img.src = e.target.result;
		        img.style.maxWidth = "300px";  // 设置图片最大宽度
		        img.style.maxHeight = "300px"; // 设置图片最大高度
		        picturePreview.appendChild(img);  // 将图片添加到预览框
		    };
		
		    // 读取文件内容
		    reader.readAsDataURL(file);
		        }   
		        
		// 预定义的标签
	    var predefinedTags = ["HTML", "CSS", "JavaScript", "Web"];
	
	    // 获取DOM元素
	    var tagContainer = document.getElementById("tagContainer");
	    var tagInput = document.getElementById("tagInput");
	
	    // 初始化已有标签
	    for (var i = 0; i < predefinedTags.length; i++) {
	        createTag(predefinedTags[i]);
	    }
	
	    // 添加输入框事件监听
	    tagInput.addEventListener("keydown", function (event) {
	        if (event.key === "Enter" || event.key === ",") {
	            event.preventDefault();
	            addTag(tagInput.value.trim());
	        }
	    });
	    
	    // 监听时间单位选择变化
    	document.getElementById("timeUnit").addEventListener("change", function () {
	        // 获取选中的时间单位
	        var selectedUnit = this.value;
	
	        // 获取输入框中的时间值
	        var preparationTime = document.getElementById("preparationTimeInput").value;
	
	        // 如果选择的是"hours"，则将时间值乘以60
	        if (selectedUnit === "hours") {
	            preparationTime *= 60;
	        }
	
	        // 更新输入框中的值
	        document.getElementById("preparationTimeInput").value = preparationTime;
	    });
	    
    </script>
</body>
</html>
